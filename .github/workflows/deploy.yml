name: Deploy to Termux (Cloudflare Tunnel)

on:
  push:
    branches: ['main']

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: TERMUX
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # NestJS는 Node.js 16+ 필요 (vscoke-api는 Node 20 권장)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies & Build
        run: |
          npm ci
          npm run build
          # 압축 파일 생성 (전송 속도 최적화: dist 폴더와 설정 파일들을 하나로 묶음)
          tar -czf deploy.tar.gz dist package.json package-lock.json

      - name: Install cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.TERMUX_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "Host ${{ secrets.TERMUX_HOST }}" >> ~/.ssh/config
          echo "  User ${{ secrets.TERMUX_USER }}" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  ProxyCommand cloudflared access ssh --hostname %h" >> ~/.ssh/config

      # 대상 디렉토리가 없으면 생성
      - name: Prepare Target Directory
        run: |
          ssh ${{ secrets.TERMUX_HOST }} "mkdir -p ~/projects/vscoke-api"

      # 경로 및 상태 디버깅
      - name: Debug Remote Path
        run: ssh ${{ secrets.TERMUX_HOST }} "pwd && ls -F"

      # 기존 프로세스 삭제 (확실한 중지)
      - name: Delete App Process
        run: |
          ssh ${{ secrets.TERMUX_HOST }} "pm2 delete vscoke-api || true"
          sleep 5

      - name: Deploy Files (Compressed)
        run: |
          # 압축 파일 전송 (파일 N개 전송 -> 1개 전송으로 Latency 최소화)
          scp deploy.tar.gz ${{ secrets.TERMUX_HOST }}:~/projects/vscoke-api/

      - name: Extract & Restart
        run: |
          # 원격지: 기존 dist 삭제 -> 압축 해제 -> 압축파일 삭제 -> 의존성 설치 -> 앱 재시작
          ssh ${{ secrets.TERMUX_HOST }} "cd ~/projects/vscoke-api && rm -rf dist && tar -xzf deploy.tar.gz && rm deploy.tar.gz && npm ci --omit=dev --ignore-scripts && pm2 start dist/src/main.js --name vscoke-api"
