name: Deploy to Termux (Cloudflare Tunnel)

on:
  push:
    branches: ['main']

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: TERMUX
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # NestJS는 Node.js 16+ 필요 (vscoke-api는 Node 20 권장)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies & Build
        run: |
          npm ci
          npm run build

      - name: Install cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.TERMUX_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "Host ${{ secrets.TERMUX_HOST }}" >> ~/.ssh/config
          echo "  User ${{ secrets.TERMUX_USER }}" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  ProxyCommand cloudflared access ssh --hostname %h" >> ~/.ssh/config

      # 대상 디렉토리가 없으면 생성
      - name: Prepare Target Directory
        run: |
          ssh ${{ secrets.TERMUX_HOST }} "mkdir -p ~/projects/vscoke-api"

      # 파일 삭제 전 앱 중지 (크래시 방지)
      - name: Stop App
        run: ssh ${{ secrets.TERMUX_HOST }} "pm2 stop vscoke-api || true"

      # 기존 dist 디렉토리 정리 (좀비 코드 방지)
      - name: Clean Remote Directory
        run: |
          ssh ${{ secrets.TERMUX_HOST }} "rm -rf ~/projects/vscoke-api/dist"

      - name: Deploy Files
        run: |
          # dist 폴더와 package.json, lock 파일 전송
          scp -r dist package.json package-lock.json ${{ secrets.TERMUX_HOST }}:~/projects/vscoke-api/

      - name: Restart App
        run: |
          # 의존성 설치 (devDependency 제외) 및 PM2 재시작
          ssh ${{ secrets.TERMUX_HOST }} "cd ~/projects/vscoke-api && npm ci --omit=dev --ignore-scripts && pm2 restart vscoke-api || pm2 start dist/main.js --name vscoke-api"
